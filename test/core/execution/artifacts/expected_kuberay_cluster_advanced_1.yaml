apiVersion: ray.io/v1
kind: RayCluster
metadata:
  labels:
    ray.io/scheduler-name: volcano
    ray.io/priority-class-name: high-priority
    volcano.sh/queue-name: qqq
    controller-tools.k8s.io: "1.0"
  annotations:
    ray.io/ft-enabled: "true"
    kubernetes.io/ingress.class: nginx-private
    nginx.ingress.kubernetes.io/proxy-body-size: 8m
  name: ml-training-cluster
  namespace: ray
spec:
  rayVersion: 2.43.0
  headGroupSpec:
    serviceType: ClusterIP
    enableIngress: true
    rayStartParams:
      dashboard-host: '0.0.0.0'
      num-cpus: "0"
      redis-username: xxx
      redis-password: yyy
    template:
      metadata:
        labels: {}
      spec:
        containers:
          - name: ray-head
            image: custom/ray:gpu
            env:
              - name: RAY_JOB_AGENT_PULL_MODE
                value: true
            ports:
              - containerPort: 6379
                name: gcs
              - containerPort: 6377
                name: agent
            lifecycle:
              preStop:
                exec:
                  command: ["/bin/sh","-c","ray stop"]
            securityContext:
              capabilities:
                add:
                  - SYS_PTRACE
            volumeMounts:
              - mountPath: /dev/shm
                mountPropagation: None
                name: dshm
            resources:
              limits:
                cpu: "4"
                memory: "16Gi"
                nvidia.com/gpu: "0"
              requests:
                cpu: "4"
                memory: "16Gi"
                nvidia.com/gpu: "0"
        volumes:
          - name: dshm
            emptyDir:
              medium: Memory
  workerGroupSpecs:
    - replicas: 4
      minReplicas: 2
      maxReplicas: 8
      groupName: "gpu-workers"
      rayStartParams:
        resources: {}
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: "ray-worker"
              image: custom/ray:gpu
              env:
                - name: RAY_JOB_AGENT_PULL_MODE
                  value: true
              lifecycle:
                preStop:
                  exec:
                    command: ["/bin/sh","-c","ray stop"]
              securityContext:
                capabilities:
                  add:
                    - SYS_PTRACE
              volumeMounts:
                - mountPath: /dev/shm
                  mountPropagation: None
                  name: dshm
              resources:
                limits:
                  cpu: "8"
                  memory: "32Gi"
                  nvidia.com/gpu: 2
                requests:
                  cpu: "8"
                  memory: "32Gi"
                  nvidia.com/gpu: 2
          volumes:
            - name: dshm
              emptyDir:
                medium: Memory